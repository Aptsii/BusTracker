<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BusTracker</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
    <style>
        html,
        body {
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            height: 100%;
        }

        h1 {
            margin: 10px;
        }

        #map {
            width: 100%;
            height: 100%;
            border: 1px solid black;
            border-radius: 10px;
        }

        #box {
            display: flex;
            flex-direction: row;
        }

        #selBox {
            display: flex;
            align-items: center;
            margin: 10px;
        }

        #selBox label {
            margin-right: 10px;
        }

        #busLastLoc {
            margin: 10px;
        }
    </style>
</head>

<body>
    <h1>BusTracker</h1>
    <div id="box">
        <div id="selBox">
            <label for="city">도시</label>
            <select name="city" id="city"></select>
        </div>

        <div id="selBox">
            <label for="bus">버스 번호</label>
            <select name="bus" id="bus"></select>
        </div>

        <div id="selBox">
            <label for="busSel">버스 선택</label>
            <select name="busSel" id="busSel"></select>
        </div>

        <div id="selBox">
            <label for="time">시간</label>
            <select name="time" id="time"></select>
        </div>
    </div>

    <p id="busLastLoc">버스 마지막 위치 :</p>

    <div id="map"></div>

    <script>
        /* 
        MapBox(지도), 버스 노선 정보, 버스 위치 정보 총 3개의 API를 사용했습니다.
        */
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2VvamgyajEiLCJhIjoiY21iNG95bWgxMGQ5azJpcTYwZmp6YTZzbSJ9.85nfoQRfn_yj-lBQslHTaA'; // MapBox API 액세스 토큰
        const serviceKey = "XQ%2FN7khTTUo7HqTGit9F57PV8IwHasPVh1%2FShC5C%2F1f2yBYDaJ2fGGCq4GJBfpkjzrWRmKJIDvut0kxJS73Npw%3D%3D"; // 공공데이터 포털 API 서비스키

        const map = new mapboxgl.Map({ // MapBox API의 지도 기본 설정
            container: 'map',
            style: 'mapbox://styles/seojh2j1/cmb5vp0s800g701rkbtvqfxc6',
            center: [126.77724, 37.4888],
            pitch: 60,
            zoom: 16
        });

        map.on('style.load', () => { // MapBox API의 맵을 불러와서 해당 맵의 상세 설정
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
            map.setConfigProperty('basemap', 'lightPreset', 'day');
        });

        let cityCode = ""; // 도시 코드
        let routeId = ""; // 버스 번호
        let busSelNum = 0; // 버스 선택 ( 하나의 버스여도 여러개가 존재하기 때문 )

        let lat = null; // 위도
        let lng = null; // 경도
        let prev = null; // 위도,경도 이전 값 
        let next = null; // 위도,경도 다음 값 

        let busLocInterval = null; // 인터벌 중복 실행 방지

        let isFirst = true; // 첫 위치 설정 여부
        let isAnimating = false; // 애니메이션 상태

        const busMarker = new mapboxgl.Marker().setLngLat([0, 0]).addTo(map); // MapBox API의 마커 생성

        const bus = document.getElementById("bus"); // 버스 번호 선택 셀렉트 박스
        const busSel = document.getElementById("busSel"); // 버스 선택 셀렉트 박스

        function clearSelBox(el) { // 도시를 변경하거나 버스 번호를 선택했을 경우 셀렉트 박스를 비우고 다시 채우기 위한 함수
            while (el.children.length > 0) { // 도시 드롭다운 초기화
                el.removeChild(el.children[0]); // 도시 목록의 첫 번째 자식 <option> 요소를 제거함.
            }
        }

        function setMapTime() { // MapBox API의 지도 시간대를 변경하기 위한 함수
            const timeSel = document.getElementById("time"); // 시간대 선택 셀렉트 박스
            const timeList = ["day", "night", "dusk", "dawn"]; // 시간대 종류

            for (const x of timeList) { //timeList 목록을 셀렉트 박스에 추가
                let el = document.createElement("option") // <option> 요소 생성
                el.setAttribute('value', x); // <option> 요소의 value 값 지정
                el.appendChild(document.createTextNode(x)); // <option> 요소의 text 값 지정
                timeSel.appendChild(el); // <select> 요소에 추가
            }

            function onTimeChange() {
                map.setConfigProperty('basemap', 'lightPreset', `${timeSel.value}`);
                console.log(timeSel.value);
            }

            timeSel.removeEventListener("change", onTimeChange); // 기존 이벤트 리스너 제거 (중복 방지)
            timeSel.addEventListener("change", onTimeChange); // 새로운 이벤트 리스너 등록
        }

        function getCityCode() { // 도시 코드를 불러오는 함수
            const url = `http://apis.data.go.kr/1613000/BusRouteInfoInqireService/getCtyCodeList?serviceKey=${serviceKey}&_type=json`
            const xhr = new XMLHttpRequest(); // XMLHttpRequest 객체 생성

            xhr.open("GET", url); // 비동기 방식으로 Request를 오픈
            xhr.onreadystatechange = function () { // Event Handler 상태 변화 체크
                if (xhr.readyState === 4 && xhr.status === 200) { // 요청 완료 && 응답 성고 시
                    try {
                        const data = JSON.parse(xhr.responseText); // JSON 형식으로 파싱
                        const citySel = document.getElementById("city"); // 도시 선택 셀렉트 박스
                        const cityList = data.response.body.items.item; // 도시 목록 데이터

                        for (const x of cityList) { //cityList를 셀렉트 박스에 추가
                            let el = document.createElement("option") // <option> 요소 생성
                            el.value = x.citycode; // <option> 요소의 실제 값 설정
                            el.text = x.cityname; // <option> 요소의 텍스트 값 설정
                            citySel.appendChild(el); // <select> 요소에 추가
                        }

                        function onCityChange() { // 도시 선택 변경 이벤트 핸들러 함수
                            cityCode = citySel.value; // 선택된 도시 코드 저장
                            clearSelBox(bus); // 버스 번호 셀렉트 박스 초기화 ( 중복 추가 방지 ) 
                            clearSelBox(busSel); // 버스 선택 셀렉트 박스 초기화 ( 중복 추가 방지 )
                            console.log(cityCode)
                            console.log(`URL 주소 : ${url}`);
                            getBusNum(cityCode); // 해당 도시의 버스 번호 목록 조회 함수 호출
                        }

                        citySel.removeEventListener("change", onCityChange); // 기존 이벤트 리스너 제거 (중복 방지)
                        citySel.addEventListener("change", onCityChange); // 새로운 이벤트 리스너 등록
                        console.log(cityList)
                    } catch (e) {
                        console.log(e); // try, catch를 이용해 오류 발생 시 콘솔에 출력
                    }
                } else {
                    console.log(xhr.status); // 요청 실패 시 상태 코드 출력
                }
            }
            xhr.send(); // Request 전송
        }

        function getBusNum(citycode) { // 버스 번호 목록 조회 함수
            const url = `http://apis.data.go.kr/1613000/BusRouteInfoInqireService/getRouteNoList?serviceKey=${serviceKey}&cityCode=${citycode}&_type=json`
            const xhr = new XMLHttpRequest(); // XMLHttpRequest 객체 생성

            xhr.open("GET", url); // 비동기 방식으로 Request를 오픈
            xhr.onreadystatechange = function () { // Event Handler 상태 변화 체크
                if (xhr.readyState === 4 && xhr.status === 200) { // 요청 완료 && 응답 성고 시
                    try {
                        const data = JSON.parse(xhr.responseText); // JSON 형식으로 파싱
                        const busList = data.response.body.items.item; // 버스 목록 데이터

                        for (const x of busList) { // busList를 셀렉트 박스에 추가 
                            let el = document.createElement("option") // <option> 요소 생성
                            el.value = x.routeid; // <option> 요소의 실제 값 설정
                            el.text = `${x.routeno}번`; // <option> 요소의 텍스트 값 설정
                            bus.appendChild(el); // <select> 요소에 추가
                        }

                        function onBusNumChange() { // 버스 번호 변경 이벤트 핸들러 함수
                            routeId = bus.value; // 선택된 버스 번호 저장
                            clearSelBox(busSel); // 버스 선택 셀렉트 박스 초기화
                            console.log(routeId)
                            console.log(`URL 주소 : ${url}`);
                            busSelect(cityCode, routeId); // 해당 버스의 갯수를 조회하는 함수 호출
                        }

                        bus.removeEventListener("change", onBusNumChange); // 기존 이벤트 리스너 제거 (중복 방지)
                        bus.addEventListener("change", onBusNumChange); // 새로운 이벤트 리스너 등록
                        console.log(busList)
                    } catch (e) {
                        console.log(e);
                    }
                } else {
                    console.log(xhr.status);
                }
            }
            xhr.send(); // Request 전송
        }

        function busSelect(cityCode, routeId) { // 해당 버스들 중 하나를 선택하는 함수
            const busSelUrl = `http://apis.data.go.kr/1613000/BusLcInfoInqireService/getRouteAcctoBusLcList?serviceKey=${serviceKey}&cityCode=${cityCode}&routeId=${routeId}&_type=json`;
            const xhr = new XMLHttpRequest(); // XMLHttpRequest 객체 생성

            xhr.open("GET", busSelUrl); // 비동기 방식으로 Request를 오픈
            xhr.onreadystatechange = function () { // Event Handler 상태 변화 체크
                if (xhr.readyState === 4 && xhr.status === 200) { // 요청 완료 && 응답 성고 시
                    try {
                        const data = JSON.parse(xhr.responseText); // JSON 형식으로 파싱
                        const bus = data.response.body.items.item; // 해당 버스 여러대의 데이터
                        const busList = []; // 버스 개수를 저장하기 위한 리스트

                        for (let i = 0; i < bus.length; i++) { // 버스의 갯수만큼 반복
                            busList.push(i + 1); // busList에 추가
                        }

                        for (const x of busList) { // busList의 목록을 셀렉트 박스에 추가
                            let el = document.createElement("option") // <option> 요소 생성
                            el.setAttribute('value', x); // <option> 요소의 value 값 지정
                            el.appendChild(document.createTextNode(x)); // <option> 요소의 text 값 지정
                            busSel.appendChild(el); // <select> 요소에 추가
                        }

                        function onBusSelChange() { // 버스 선택 변경 이벤트 핸들러 함수
                            isFirst = true; // 첫 위치 설정 여부
                            isAnimating = false; // 애니메이션 상태 초기화 (다시 시작 가능하도록)
                            busSelNum = parseInt(busSel.value); // 선택된 버스 번호를 숫자로 변환하여 저장
                            console.log(`URL 주소 : ${busSelUrl}`);
                            getBusLocation(cityCode, routeId, busSelNum); // 선택된 버스의 위치 정보 요청 함수 호출
                        }

                        busSel.removeEventListener("change", onBusSelChange); // 기존 이벤트 리스너 제거 (중복 방지)
                        busSel.addEventListener("change", onBusSelChange); // 새로운 이벤트 리스너 등록

                    } catch (e) {
                        console.log(e);
                    }
                } else {
                    console.log(xhr.status);
                }
            };
            xhr.send();
        }

        function getBusLocation(cityCode, routeId, busSelNum) { // 선택된 버스의 위치를 불러오는 함수
            const busLocUrl = `http://apis.data.go.kr/1613000/BusLcInfoInqireService/getRouteAcctoBusLcList?serviceKey=${serviceKey}&cityCode=${cityCode}&routeId=${routeId}&_type=json`;
            const xhr = new XMLHttpRequest(); // XMLHttpRequest 객체 생성

            xhr.open("GET", busLocUrl); // 비동기 방식으로 Request를 오픈
            xhr.onreadystatechange = function () { // Event Handler 상태 변화 체크
                if (xhr.readyState === 4 && xhr.status === 200) { // 요청 완료 && 응답 성고 시
                    try {
                        const data = JSON.parse(xhr.responseText); // JSON 형식으로 파싱

                        const LastLoc = document.querySelector("#busLastLoc"); // 버스가 마지막으로 들린 버스 정류장 위치

                        const items = data.response.body.items.item; // 버스 위치 데이터

                        if (!Array.isArray(items)) { // items가 배열이 아닐 경우 경고
                            console.warn("버스 데이터가 배열이 아닙니다.")
                            if (busSelNum !== 0) { // 유효하지 않은 버스 번호일 경우
                                alert("버스 번호가 잘못되었습니다.")
                            }
                        } else if (busSelNum < 0 || busSelNum >= items.length) { // busSelNum이 배열 범위를 벗어나면 경고
                            alert("유효하지 않은 버스 선택 번호입니다.")
                        }

                        const bus = Array.isArray(items) ? items[busSelNum] : items; // items가 배열이면 busSelNum 번째 아이템 선택, 아니면 단일 객체 사용

                        const latRaw = bus.gpslati; // 위도 값
                        const lngRaw = bus.gpslong; // 경도 값

                        if (latRaw != null && lngRaw != null) { // 유효한 위치 정보가 있을 경우
                            lat = parseFloat(bus.gpslati); // 위도 변환
                            lng = parseFloat(bus.gpslong); // 경도 변환

                            if (next !== null) { // 이전 위치가 있으면 복사, 없으면 현재 위치로 초기화
                                prev = [...next];
                            } else {
                                prev = [lng, lat];
                            }
                            next = [lng, lat]; // 현재 위치 저장

                            moveMarker(prev, next); // 위치를 기반 마커 이동 함수 호출

                            if (busLocInterval) clearInterval(busLocInterval); // 기본 인터벌이 있으면 삭제 후 새로 생성 ( 중복 방지 )
                            busLocInterval = setInterval(() => { // 인터벌 설정 ( 10초마다 호출 )
                                next = [lng, lat]; // 현재 위치 저장
                                getBusLocation(cityCode, routeId, busSelNum); // 10초 마다 위치 갱신
                                console.log(`URL 주소 : ${busLocUrl}`);
                                console.log(`prev : ${prev}, next : ${next}`);
                            }, 10000);

                            LastLoc.textContent = `버스 마지막 위치 : ${bus.nodenm}`; // 마지막으로 들린 버스 정류장 정보 표시

                            console.log(bus);
                            console.log(lng, lat);
                        } else {
                            console.warn("위치 정보가 없습니다.", bus); // 위치 정보가 없을 시 경고
                        }
                    } catch (e) {
                        console.log(e);
                    }
                } else {
                    console.log(xhr.status);
                }
            };
            xhr.send();
        }

        function moveMarker(prev, next) { // 위치를 기반으로 마커를 이동시키는 함수
            /*
            해당 함수는 MapBox API 안에 있는 Directions API를 사용하였습니다.
            Mapbox Directions API는 두 지점(또는 여러 지점) 사이의 최적 경로를 계산해 주는 서비스입니다.
            자동차, 도보, 자전거 등 다양한 이동 수단에 맞춘 경로를 제공해서 
            저는 이 API를 사용해서 마커가 도로를 따라가게 만들었습니다.
            또한 해당 API는 GeoJSON(공간 정보(위치, 도형 등 지리 데이터)를 표현하기 위해 JSON을 확장한 형식)을 사용하였습니다.
            */

            if (isAnimating) { // 이미 애니메이션이 진행 중이면 중복 실행 방지
                console.log("애니메이션이 이미 실행 중입니다.");
                return;
            }
            isAnimating = true; // 애니메이션 시작 설정

            const DirectionUrl = `https://api.mapbox.com/directions/v5/mapbox/driving/${prev};${next}?overview=full&geometries=geojson&access_token=${mapboxgl.accessToken}`;
            const xhr = new XMLHttpRequest(); // XMLHttpRequest 객체 생성

            xhr.open("GET", DirectionUrl); // 비동기 방식으로 Request를 오픈
            xhr.onreadystatechange = function () { // Event Handler 상태 변화 체크
                if (xhr.readyState === 4 && xhr.status === 200) { // 요청 완료 && 응답 성고 시
                    try {
                        const data = JSON.parse(xhr.responseText); // JSON 형식으로 파싱
                        console.log(data);
                        const coords = data.routes[0].geometry.coordinates; // 경로 좌표 배열

                        let i = 0;
                        const interval = 10000 / coords.length; // 애니메이션 간격 계산 (총 10초를 좌표 개수로 나눔)

                        function animate() { // 애니메이션 함수 정의
                            if (i < coords.length) {
                                map.jumpTo({ center: coords[i] }); // 해당 좌표로 지도 중심 이동
                                busMarker.setLngLat(coords[i]); // 해당 좌표로 마커 위치 변경
                                i++;
                                setTimeout(animate, interval); // 일정 간격 후 재귀 호출
                            } else {
                                isAnimating = false; // 애니메이션 종료
                            }
                        }

                        if (isFirst === true) { // 첫 실행 시에는 지도 줌 및 위치 설정만 하고 애니메이션은 실행하지 않음
                            const [lng, lat] = coords[coords.length - 1]; // 좌표 가져오기
                            busMarker.setLngLat([lng, lat]); // 마커 위치 설정
                            map.jumpTo({ center: [lng, lat], zoom: 16 }); // 지동 중심 및 줌 조정
                            isFirst = false;
                            isAnimating = false;
                            return;
                        } else {
                            animate(); // 첫 실행이 아니면 애니메이션 실행
                            console.log(`isFirst = ${isFirst}`);
                        }
                    } catch (e) {
                        console.log(e);
                    }
                }
            }
            xhr.send();
        }

        getCityCode();
        setMapTime();

        /*
        API 실습을 진행하면서 해결하지 못한 문제가 있습니다.
        
        1. Mapbox Directions API를 사용하다 보니 해당 API가 좌표를 잘못 계산해서 한참을 돌아가는 경우가 발생합니다. 
           해당 문제는 API 자체의 한계로 보여서 현재로선 해결이 어려울 것 같습니다.

        2. 두번째로 moveMarker 함수 내 animate 애니메이션이 부드럽지 않고 뚝뚝 끊기는 문제가 있습니다.
           선형 보간(두 지점 사이의 값을 직선으로 연결하여 추정하는 방법)을 적용하면 개선할 수 있을 것 같지만 구현이 까다로워 적용하지 못했습니다.
           또한 애니메이션을 적용하기 위해 갱신된 API를 호출하고 실행하는 과정에서 몇 초 정도의 차이가 발생합니다.
        
        3. 공공데이터 포털의 버스 위치 정보 API의 갱신 주기가 10~20초 라고 적혀있는데, 실제 갱신 간격이 랜덤하고 일정하지 않습니다.
           따라서 10초마다 API를 호출해도 실시간 갱신이 제대로 이루어지지 않아 실시간 정보로 보기 어렵습니다.
           이 문제도 API 제공 방식의 한계로 인해 해결하지 못했습니다.
        */
    </script>
</body>

</html>